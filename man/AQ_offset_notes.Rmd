---
title: "Notes on air quality offset calculations"
author: "Christiaan Pauw, Nova Instituut"
date: "3 December 2015"
output: word_document
---
```{r echo=FALSE, message=FALSE}
library(raster)
library(rasterVis)
library(knitr)
source('~/Documents/Rpakette/AQoffset/R/knipNA.R')
wd <- "/Users/christiaanpauw/Documents/Rpakette/AQoffset/"
setwd("/Users/christiaanpauw/Documents/Rpakette/AQoffset/")
rdir <-  file.path(paste(wd, "R/", sep=""))
datadir <- file.path(paste(wd, "Data/", sep = ""))
source(paste(rdir,'/count_exceed.R', sep=""))
source(paste(rdir, '/raster_dist_sum.R', sep=""))
source(paste(rdir, '/API.R', sep=""))
load("/Users/christiaanpauw/Documents/Rpakette/AQoffset/MDB.Rda")
new.proj <- "+proj=utm + south + zone=35 ellps=WGS84" 
require(rgdal)
MDB <- spTransform(MDB, CRS(new.proj))
load(paste("Data/", "kwaza_household_census.Rda", sep=""))
kwaN <- as.character(KWA@data$SP_NAME)
kwaCoor <- coordinates(KWA)
addkwa <- function(){layer(sp::sp.polygons(KWA, lwd = 0.25))}
txtkwa <- function(){layer(panel.text(x = coordinates(KWA)[,1], y = coordinates(KWA)[,2], label = as.character(KWA@data$SP_NAME), cex = 0.5))}
```

# Simulated example

A simple simulated example is used to illuminate key aspects of the air quality offset problem related to industrial sources that is offset by domestic air pollution and to test the calculation functions. The main computational challenge in air quality offsetting is spatial and temporal resolution at which the calculation takes place. This is an issue that has to be taken into account in the calculations but also in reporting and representation. The calculation tools developed for the offset methodology maintain the spatial of the original dispersion model and aggregates the data from the original dispersion model to 24 hours as this is the default averaging period relevant to acute expose in the methodology.

```{r echo=FALSE}
load(paste(datadir, "baseline365.Rda", sep=""))
baseline365 <- baseline365/10
load(paste(datadir, "project365.Rda", sep=""))
```

## Setup

For the purpose of this simulated the following assumptions apply:

* Population
    + Assume a town with a number of suburbs
    + Different distribution of energy carriers in each suburb
* Pollution sources
    + One large source of SO2 relatively far from the town
    + A smaller source of PM10 closer to town
    + Distributed household PM10 sources within the town
* Offset scenario
    + Reduce household emissions of x% of households by z%
    + Baseline for the large SO2 source is a level of emissions 80% of its current emissions
    + Calculation is done for a period of one year
    + A number of offset calculation methods are demonstrated

## Pollution sources

### Household sources
To calculate the potential of a household-based air quality offset intervention, one needs to know the the distribution of households and their energy use patterns. The figure below shows the distribution of households by energy carrier used for heating in the example data set. 

```{r echo=FALSE}
load(paste(datadir, "hh_s.Rda", sep=""))
load(paste(datadir, "baseline365.Rda", sep=""))
levelplot(hh_s[[-c(1, 7, 9)]], pretty = TRUE, par.settings=BuRdTheme, main = "Number of households by energy carrier used for heating", scales=list(draw=FALSE)) + layer(sp::sp.polygons(MDB))
```

## Baseline scenario
The baseline scenario is that domestic coal use would continue unabated. 

### Household emissions and atmospheric impact
Each energy carrier type is associated with an expected emission rate that may vary daily or seasonally. For the sake of an offset calculation is not needed to estimate all emissions from households in a specific area but only those emissions that are addressed by the interventions (i.e. that differ in the baseline and the project scenario).  

PM10 emission must be modeled for household coal use because the target pollutant in the example case is PM10 and the target emission source in domestic coal burning. A summary of 365 days of PM10 concentrations resulting from household coal burning is shown below for the simulated dataset (the panels represent [left to right, top to bottom], the first,  25th, 50th percentiles, the mean, the 75th and 99th percentiles as well as the standard deviation, inter-quartile range and 99% range). 

```{r echo=FALSE, message=FALSE}
names(baseline365) <- gsub("Households", "HH", names(baseline365))
hh <- baseline365[[grep("HH", names(baseline365))]]
raster_dist_plot(hh, multi = NULL, mn = "PM10 concentrations resulting from household coal burning", "365 days") +layer(sp::sp.polygons(MDB, lwd = 0.3))
```

### Household Impact
  
The health risk posed to a single susceptible individual is used as the impact metric. This is the simplest of the impact metrics allowed by the the methodology. Only PM10 from households is qualified. This is a conservative since the project will also lead to the reduction in other emissions such as SO2. The project impact is therefore likely higher that what is expressed here but any additional benefits are discounted i the interest of a conservative estimate of the impact of the project activity. 

A summary of the API score for PM10 and SO2 from households are shown below  

```{r echo=FALSE, message=FALSE}
# onthou om SO2 ook in te sit (met 'n post hoc funksie)
API_bhh <- rasterAPI(s = hh)
raster_dist_plot(API_bhh, mn = "Baseline API for households", sb = "365 days")+layer(sp::sp.polygons(MDB, lwd = 0.3))
```

### Industrial sources
The typical offset scenario will be that a large industrial point source will be situated some distance away from densely inhabited areas but that inhabited areas may be affected from time to time. A summary of the baseline atmospheric states resulting from the industrial source in the simulated dataset is given below. 

```{r echo=FALSE}
names(baseline365) <- gsub("X|Y", "", names(baseline365))
names(baseline365) <- gsub("Industry", "Indus", names(baseline365))
raster_dist_plot(ss = baseline365, multi = c("Indus_pm", "Indus_so2"), mn = "Ambient concentrations from industrial emissions", sb = "PM10 and SO2 over 365 days") + layer(sp::sp.polygons(MDB, lwd = 0.3))
```

Not only short term exposure is important, but also long term exposure because the largest effect of air pollution is likely to be the loss of life years due to chronic exposure to air pollution. The annual averaging period must therefore also be accounted for. The annual average PM10 and SO2 concentrations resulting from the simulated industrial source are given below. 

```{r echo=FALSE}
baseline.year <- raster_ave_type(baseline365)
levelplot(baseline.year, par.settings = BuRdTheme, main = "Annual average baseline PM10 and SO2", sub = "1 year") + layer(sp::sp.polygons(MDB, lwd = 0.3))
```

In the same way as with households, the impact of industrial sources can be expressed in terms of health risk with an air pollution index score for each 24 hour period. This is shown below. 

```{r echo = FALSE}
API_bi <- rasterAPI(baseline365[[grep("Indus", names(baseline365))]])
raster_dist_plot(API_bi, mn = "Baseline API for industries", sb = "365 days") + layer(sp::sp.polygons(MDB, lwd = 0.3))
```

## Population
Not all calculation approaches require population characteristics. Methods making use of exposure, intake or aggregated health outcomes must make use of  basic population characteristics. Such data can be stored as counts of men and women (possible differentiated into age categories) in each cell. Exposure in each time period is expressed as the product of people and ambient concentrations. 

```{r echo = FALSE}
load(paste(datadir, "people.exposed.year.Rda", sep=""))
pext <- knipNA(people[[1]])
levelplot(crop(people, pext), par.settings = BuRdTheme, mn = "Total, male and female population", sb = "Annual average", scales = list(draw=FALSE)) + layer(sp::sp.polygons(MDB, lwd = 0.3))
exposed.baseline <- people * baseline365
names(exposed.baseline) <- names(baseline365)
raster_dist_plot(crop(exposed.baseline, pext), multi = c("pm10", "so2"), mn = "Population exposure to PM10 and SO2", sb = "365 days") + layer(sp::sp.polygons(MDB, lwd = 0.3))
```

In the example above it is obvious that the bulk of the impact, as expressed in population exposure, is located in a small. The exposures shown above multiplied by an breathing rate yields the intake used in the standards weighted intake approach. 

## Incidence rates

Very often incidence rates for health outcomes are not available at the same resolution as the exposure data and one must assume regional or national incidence rates to apply to the target area.

# Offset scenatio
In the example dataset the following scenarios are assumed. It is assumed that in the baseline scenario the industrial source would reduce SO2 emissions by 20% and households would continue coal at baseline rates. In the project scenario the industrial source would not curtail SO2 emissions but that an intervention would be implemented that reduces emissions by 80% on 50% of coal using households. 

To calculate the project impact using the health risk approach the baseline and project atmospheric state is calculated first. In this case the pollutants under consideration are PM10 and SO2 from industrial sources and PM10 from domestic sources. Because acute and chronic exposure are both important the impact is shown both at the 24h and the annual averaging period. 

## Baseline impact
### Acute
The baseline impact of acute exposure to pollutants from households and industrial sources over a 24 hour period has already been shown above. Since the API used is by design additive for all pollutants, the baseline impact is the sum of the household and project impact for each day of the year

```{r echo = FALSE}
API_b <- API_bhh + API_bi
raster_dist_plot(API_b, mn = "Baseline API for households and industry combined", sb = "365 days") + layer(sp::sp.polygons(MDB, lwd = 0.3))
```

### Chronic

The chronic impact is a function of the annual average for the baseline scenario that was given above.

## Project impact

### Acute impact of households in the project scenario
The impact, expressed as and 24-hour API score of households in the project scenario is shown below. 

```{r echo=FALSE}
load(paste(datadir, "project365.Rda", sep=""))
names(project365) <- gsub("Households", "HH", names(project365))
names(project365) <- gsub("IndustryY|IndustryX", "Indus", names(project365))
API_phh <- rasterAPI(project365[[grep("HH", names(project365))]])
raster_dist_plot(API_phh, mn = "Project API for households", sb = "365 days") + layer(sp::sp.polygons(MDB, lwd = 0.3))
```

### Acute impact of the industrial source in the project scenario
The impact, expressed as and 24-hour API score for the industrial source in the project scenario is shown below. 

```{r echo=FALSE}
API_pi <- rasterAPI(project365[[grep("Indus", names(project365))]])
raster_dist_plot(API_pi, mn = "Project API for industries", sb = "365 days") + layer(sp::sp.polygons(MDB, lwd = 0.3))
```

### Consolidated project impact

The total impact in the project scenario is the sum of household and industry impacts. 

```{r echo=FALSE}
API_p <- API_phh + API_pi
raster_dist_plot(API_b, mn = "Baseline API for households and industry combined", sb = "365 days") + layer(sp::sp.polygons(MDB, lwd = 0.3))
```

### Chronic
The chronic impact is calculated in the same way as the acute impact but is based on annual averages

# Offset impact

The impact of the offset intervention is the difference between baseline and project impact. 

```{r echo=FALSE}
API_diff <- API_b - API_p
raster_dist_plot(API_diff, mn = "Impact of the offset intervention", sb = "365 days") + layer(sp::sp.polygons(MDB, lwd = 0.3))
```

The counts of API difference is important because one has to ascertain if there are areas that are worse off because of the offset. 

```{r echo=FALSE}
levelplot(count_exceed(API_diff, min = 3, max = 10, by = 1), main = "API differencebetween baseline and project scenario", sub = "365 days", par.settings = BuRdTheme) + layer(sp::sp.polygons(MDB, lwd = 0.3))
```

On the whole it does not seem like the there are large areas that are worse off because of the simulated offset scenario. There are however small areas where the situation is worse on some days in the project scenario compared to the baseline scenario. As is shown below, these areas are situated downwind from the industrial source but mostly upwind from the household sources. The API deficit, however is very small. 

```{r echo=FALSE}
dd <- API_diff
dd[dd > 0] <- NA
raster_dist_plot(dd, mn = "API deficit for areas worse off \nin the project scenario") + layer(sp::sp.polygons(MDB, lwd = 0.3))
```

The same phenomenon is also visible when the counts of exceedences of specific API levels are compared.

```{r echo=FALSE}
levelplot(count_exceed(API_p) - count_exceed(API_b), scales = list(draw=FALSE)) + layer(sp::sp.polygons(MDB, lwd = 0.1))
```

# Method applied to Kwazamokuhle with availible data 
```{r echo=FALSE}
#remove the other datasets here to save memory
rm(API_diff, API_b, API_p, API_phh, API_pi, project365, baseline365)
load(paste(datadir, "kwaza_eskom_24h_camx.Rda", sep = ""))
load(paste(datadir, "kwaza_eskom_year_camx.Rda", sep = ""))
load(paste(datadir, "kwaza_household_energyRaster.Rda", sep=""))
load(paste(datadir, "kwaza_API_hh.Rda", sep=""))
load(paste(datadir, "hh_24.Rda", sep=""))
kpext <- extent(KWA)
```

## Project boundary
The spatial extent of the project boundary is the extent of the ambient contribution of the managed facility above 2 ug/m3 per year or 19 ug/m3 per day in PM10 or SO2. 

## Baseline scenario
### Baseline emissions
Baseline emission are calculated from the results of a domestic fuel use survey. 

### Baseline states

The modeled baseline PM10 and SO2 resulting from household emissions in Kwazamokuhle is shown below. 
```{r echo = FALSE}
raster_dist_plot(hh_24, multi = c("pm10", "so2"), th=BuRdTheme) + addkwa()
```

The modeled baseline PM2.5, PM10 and SO2 from the industrial point source is shown below.

```{r echo=FALSE}
raster_dist_plot(crop(kwaza_eskom_24h_simple, kpext), multi = c("pm10","pm2.5", "so2")) + addkwa()
```

The count of days where the PM10 concentrations that resulted from household emissions and the industrial  point source are modeled to exceed a specified level and the is shown below for the baseline scenario. 

```{r echo = FALSE}
hh_pm10_exceed = count_exceed(hh_24, pol = "pm10", min = 20, max = 160, by = 20, knip = TRUE)
levelplot(hh_pm10_exceed, main = "Count of days when PM10 from househols \nexceeded specified concentarion", sub = "182 days") + addkwa()
```

```{r echo=FALSE}
#xl = expression(paste(mu,plain(g/m)^3))
bar_exceed(hh_pm10_exceed, ttl = "Aggregated of days when PM10 from households \nexceeded specified concentarion")
```


```{r echo = FALSE}
eskom_pm10_exceed = count_exceed(kwaza_eskom_24h_PM_SO2, pol = "pm10", min = 20, max = 160, by = 20)
levelplot(crop(eskom_pm10_exceed, kpext), main = "Count of days when PM10 from Eskom \nexceeded specified concentration", sub = "182 days", scales=list(draw=FALSE)) + addkwa()
```


```{r echo=FALSE}
bar_exceed(eskom_pm10_exceed, ttl = "Aggregated of days when PM10 from Eskom \nexceeded specified concentarion")
```

The count of days where SO2 concentration that resulted from household emissions is modeled to exceed a specified level is shown below for the baseline scenario. 

```{r echo=FALSE}
hh_so2_exceed = count_exceed(hh_24, pol = "so2", min = 20, max = 160, by = 20, knip = TRUE)
levelplot(hh_so2_exceed, main = "Count of days when SO2 from households \nexceeded specified concentration", sub = "182 days", par = BuRdTheme, scales=list(draw=FALSE)) + addkwa()
```

```{r echo=FALSE}
bar_exceed(hh_so2_exceed, ttl = "Aggregated count of days when SO2 from \nhouseholds exceeded specified concentration")
```

The count of days where SO2 from the industrial point source exceeded specified level for the baseline scenario is shown not in the same because all values are below the minimum level in the previous plot. 

### Baseline impact

The baseline impact represents the combined impact of all pollutants. A summary of the daily API resulting from households are given below.  

```{r echo=FALSE}
raster_dist_plot(kwaza_API, multi = NULL, mn = "Kwazamokuhle baseline API from households", sb = "182 days") + addkwa()
```

The baseline impact of the industrial point source for the full year is shown below.
```{r echo=FALSE}
raster_dist_plot(rasterAPI(crop(kwaza_eskom_24h_PM_SO2, kpext)), multi = NULL, mn = "Kwazamokuhle baseline API from households", sb = "182 days") + addkwa()
```

The count of days where the API that resulted from household emissions is modeled to exceed a specified level is shown below for the baseline scenario. 

```{r echo=FALSE}
levelplot(count_exceed(kwaza_API, min = 2, max = 10, by = 1, knip = TRUE) , par = BuRdTheme, scales=list(draw=FALSE), main = "Days in Kwazamokuhle where API \nfrom households exceeded specified level", sub = "182 days") + addkwa() 
```

## Project scenario
Data for the calculation of the project scenario and the impact was not availible at the time of writing.






